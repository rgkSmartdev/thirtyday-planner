# Complete Authentication & Authorization Flow Diagram

Let me explain the entire flow from client to API Gateway to microservices with detailed diagrams: 

## 1. Initial Login Flow (Authentication)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Client    â”‚
â”‚  (Browser/  â”‚
â”‚   Mobile)   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 1. POST /auth/login
       â”‚    { username, password }
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          AWS API Gateway                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  Route:  /auth/login                   â”‚     â”‚
â”‚  â”‚  Auth:  NONE (public endpoint)         â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 2. Forward request
       â”‚    (no auth check for /auth/*)
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      Auth Service (Spring Boot)        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  AuthController.login()          â”‚  â”‚
â”‚  â”‚                                  â”‚  â”‚
â”‚  â”‚  3.  Validate credentials         â”‚  â”‚
â”‚  â”‚     â€¢ Check username/password    â”‚  â”‚
â”‚  â”‚     â€¢ Query User Database        â”‚  â”‚
â”‚  â”‚                                  â”‚  â”‚
â”‚  â”‚  4. Generate JWT Tokens          â”‚  â”‚
â”‚  â”‚     â€¢ Access Token (15 min)      â”‚  â”‚
â”‚  â”‚     â€¢ Refresh Token (7 days)     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚              â”‚                          â”‚
â”‚              â–¼                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚     JWT Token Structure          â”‚  â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚  â”‚
â”‚  â”‚  Header: { alg, typ }            â”‚  â”‚
â”‚  â”‚  Payload: {                      â”‚  â”‚
â”‚  â”‚    sub: "user123",               â”‚  â”‚
â”‚  â”‚    roles: ["USER", "ADMIN"],     â”‚  â”‚
â”‚  â”‚    email: "user@example.com",    â”‚  â”‚
â”‚  â”‚    iat:  1234567890,              â”‚  â”‚
â”‚  â”‚    exp: 1234568790               â”‚  â”‚
â”‚  â”‚  }                               â”‚  â”‚
â”‚  â”‚  Signature: HMACSHA512(...)      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â”‚ 5. Return tokens
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Response to Client              â”‚
â”‚  {                                      â”‚
â”‚    "accessToken": "eyJhbGc.. .",         â”‚
â”‚    "refreshToken":  "eyJhbGc.. .",        â”‚
â”‚    "tokenType":  "Bearer",               â”‚
â”‚    "expiresIn": 900                     â”‚
â”‚  }                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â”‚ 6. Client stores tokens
               â”‚    â€¢ Access Token â†’ Memory/LocalStorage
               â”‚    â€¢ Refresh Token â†’ HttpOnly Cookie
               â”‚
               â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   Client    â”‚
        â”‚  (Stores    â”‚
        â”‚   Tokens)   â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 2. Authenticated Request Flow (Authorization)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Client    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 1. GET /api/orders/123
       â”‚    Headers: 
       â”‚    Authorization: Bearer eyJhbGc...
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   AWS API Gateway                            â”‚
â”‚                                                              â”‚
â”‚  Step 2:  Trigger Lambda Authorizer                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚         Lambda Authorizer (JWT Validator)          â”‚     â”‚
â”‚  â”‚                                                     â”‚     â”‚
â”‚  â”‚  2a. Extract JWT from Authorization header         â”‚     â”‚
â”‚  â”‚      token = "eyJhbGc..."                          â”‚     â”‚
â”‚  â”‚                                                     â”‚     â”‚
â”‚  â”‚  2b. Validate Token                                â”‚     â”‚
â”‚  â”‚      âœ“ Check signature (HMACSHA512)                â”‚     â”‚
â”‚  â”‚      âœ“ Check expiration (exp claim)                â”‚     â”‚
â”‚  â”‚      âœ“ Check issuer/audience                       â”‚     â”‚
â”‚  â”‚      âœ“ Check token not blacklisted (Redis)         â”‚     â”‚
â”‚  â”‚                                                     â”‚     â”‚
â”‚  â”‚  2c. Extract Claims                                â”‚     â”‚
â”‚  â”‚      userId = "user123"                            â”‚     â”‚
â”‚  â”‚      roles = ["USER", "ADMIN"]                     â”‚     â”‚
â”‚  â”‚      email = "user@example.com"                    â”‚     â”‚
â”‚  â”‚                                                     â”‚     â”‚
â”‚  â”‚  2d.  Generate IAM Policy                           â”‚     â”‚
â”‚  â”‚      {                                             â”‚     â”‚
â”‚  â”‚        "principalId": "user123",                   â”‚     â”‚
â”‚  â”‚        "policyDocument": {                         â”‚     â”‚
â”‚  â”‚          "Version": "2012-10-17",                  â”‚     â”‚
â”‚  â”‚          "Statement": [{                           â”‚     â”‚
â”‚  â”‚            "Effect": "Allow",                      â”‚     â”‚
â”‚  â”‚            "Action": "execute-api:Invoke",         â”‚     â”‚
â”‚  â”‚            "Resource": "arn:aws:execute-api:..."   â”‚     â”‚
â”‚  â”‚          }]                                        â”‚     â”‚
â”‚  â”‚        },                                          â”‚     â”‚
â”‚  â”‚        "context": {                                â”‚     â”‚
â”‚  â”‚          "userId": "user123",                      â”‚     ï¿½ï¿½ï¿½
â”‚  â”‚          "roles": "USER,ADMIN",                    â”‚     â”‚
â”‚  â”‚          "email": "user@example.com"               â”‚     â”‚
â”‚  â”‚        }                                           â”‚     â”‚
â”‚  â”‚      }                                             â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                        â”‚                                     â”‚
â”‚                        â”‚ If DENY â†’ 401/403 Response          â”‚
â”‚                        â”‚                                     â”‚
â”‚  Step 3: If ALLOW â†’    â–¼                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  Add Context to Request Headers                    â”‚     â”‚
â”‚  â”‚                                                     â”‚     â”‚
â”‚  â”‚  x-user-id: user123                                â”‚     â”‚
â”‚  â”‚  x-user-roles: USER,ADMIN                          â”‚     â”‚
â”‚  â”‚  x-user-email: user@example.com                    â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                        â”‚                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â”‚ 4. Forward request with
                         â”‚    user context headers
                         â”‚
                         â–¼
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚  Which Microservice?                      â”‚
     â”‚  Route: /api/orders/* â†’ Order Service     â”‚
     â”‚  Route: /api/payments/* â†’ Payment Service â”‚
     â”‚  Route: /api/users/* â†’ User Service       â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Order Service (Spring Boot)                    â”‚
â”‚                                                        â”‚
â”‚  Step 5: Security Filter Chain                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  UserContextFilter                           â”‚     â”‚
â”‚  â”‚                                              â”‚     â”‚
â”‚  â”‚  5a. Extract headers                         â”‚     â”‚
â”‚  â”‚      userId = req.getHeader("x-user-id")     â”‚     â”‚
â”‚  â”‚      roles = req.getHeader("x-user-roles")   â”‚     â”‚
â”‚  â”‚                                              â”‚     â”‚
â”‚  â”‚  5b. Build Spring Security Context          â”‚     â”‚
â”‚  â”‚      authorities = roles.split(",")          â”‚     â”‚
â”‚  â”‚                   .map(SimpleGrantedAuth)    â”‚     â”‚
â”‚  â”‚                                              â”‚     â”‚
â”‚  â”‚      authentication = new                    â”‚     â”‚
â”‚  â”‚        UsernamePasswordAuthenticationToken(  â”‚     â”‚
â”‚  â”‚          userId, null, authorities)          â”‚     â”‚
â”‚  â”‚                                              â”‚     â”‚
â”‚  â”‚  5c. Set SecurityContext                     â”‚     â”‚
â”‚  â”‚      SecurityContextHolder.getContext()      â”‚     â”‚
â”‚  â”‚        .setAuthentication(authentication)    â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                      â”‚                                 â”‚
â”‚                      â–¼                                 â”‚
â”‚  Step 6: Controller Method                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  @GetMapping("/{id}")                        â”‚     â”‚
â”‚  â”‚  @PreAuthorize("hasAnyRole('USER','ADMIN')") â”‚     â”‚
â”‚  â”‚  public ResponseEntity<Order> getOrder(      â”‚     â”‚
â”‚  â”‚      @PathVariable Long id,                  â”‚     â”‚
â”‚  â”‚      @RequestHeader("x-user-id") String uid) â”‚     â”‚
â”‚  â”‚                                              â”‚     â”‚
â”‚  â”‚  6a. Spring Security checks @PreAuthorize    â”‚     â”‚
â”‚  â”‚      âœ“ Does user have USER or ADMIN role?    â”‚     â”‚
â”‚  â”‚      â†’ YES, proceed                          â”‚     â”‚
â”‚  â”‚                                              â”‚     â”‚
â”‚  â”‚  6b. Business Logic Authorization            â”‚     â”‚
â”‚  â”‚      Order order = orderService.findById(id) â”‚     â”‚
â”‚  â”‚                                              â”‚     â”‚
â”‚  â”‚      // Check if user owns this order        â”‚     â”‚
â”‚  â”‚      if (! order.getUserId().equals(uid) &&   â”‚     â”‚
â”‚  â”‚          !hasRole("ADMIN")) {                â”‚     â”‚
â”‚  â”‚        return 403 Forbidden                  â”‚     â”‚
â”‚  â”‚      }                                       â”‚     â”‚
â”‚  â”‚                                              â”‚     â”‚
â”‚  â”‚  6c. Return response                         â”‚     â”‚
â”‚  â”‚      return ResponseEntity.ok(order)         â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â”‚ 7. Response
                     â”‚
                     â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ API Gateway â”‚
              â”‚  (Forward   â”‚
              ï¿½ï¿½  Response)  â”‚
              â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â”‚ 8. Final Response
                     â”‚
                     â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚   Client    â”‚
              â”‚  {          â”‚
              â”‚   "id": 123 â”‚
              â”‚   "items"... â”‚
              â”‚  }          â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 3. Token Refresh Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Client    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ Access Token Expired! 
       â”‚ (15 minutes passed)
       â”‚
       â”‚ 1. POST /auth/refresh
       â”‚    Body: { refreshToken:  "eyJ..." }
       â”‚    OR
       â”‚    Cookie: refreshToken=eyJ...
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      AWS API Gateway                   â”‚
â”‚  Route: /auth/refresh                  â”‚
â”‚  Auth: NONE (public endpoint)          â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 2. Forward request
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Auth Service (Spring Boot)          â”‚
â”‚                                        â”‚
â”‚  3. Validate Refresh Token             â”‚
â”‚     âœ“ Check signature                  â”‚
â”‚     âœ“ Check expiration                 â”‚
â”‚     âœ“ Check not blacklisted            â”‚
â”‚                                        â”‚
â”‚  4. Generate NEW Access Token          â”‚
â”‚     (keep same refresh token)          â”‚
â”‚                                        â”‚
â”‚  5. Return new access token            â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 6. Response
       â”‚    {
       â”‚      "accessToken": "eyJ...  (NEW)",
       â”‚      "tokenType": "Bearer",
       â”‚      "expiresIn": 900
       â”‚    }
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Client    â”‚
â”‚  (Updates   â”‚
â”‚   Token)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 4. Logout Flow (Token Blacklisting)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Client    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 1. POST /auth/logout
       â”‚    Authorization: Bearer eyJhbGc...
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      AWS API Gateway                   â”‚
â”‚  Lambda Authorizer validates token     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€ï¿½ï¿½â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 2. Forward (if valid)
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Auth Service (Spring Boot)          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  3. Extract token from header    â”‚  â”‚
â”‚  â”‚                                  â”‚  â”‚
â”‚  â”‚  4. Add to blacklist (Redis)     â”‚  â”‚
â”‚  â”‚     Key: "blacklist:eyJhbGc..."  â”‚  â”‚
â”‚  â”‚     Value: "true"                â”‚  â”‚
â”‚  â”‚     TTL: remaining token lifetimeâ”‚  â”‚
â”‚  â”‚                                  â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚      Redis Cache           â”‚  â”‚  â”‚
â”‚  â”‚  â”‚                            â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  blacklist:eyJhbGc...      â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â†’ "true" (TTL: 800s)      â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚                                  â”‚  â”‚
â”‚  â”‚  5. Clear refresh token          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 6. Success response
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Client    â”‚
â”‚  (Clears    â”‚
â”‚   Tokens)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 5. Authorization Denied Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Client    â”‚
â”‚  (USER role)â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 1. DELETE /api/orders/123
       â”‚    Authorization: Bearer eyJhbGc...
       â”‚    (Token with only USER role)
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      AWS API Gateway                   â”‚
â”‚  Lambda Authorizer validates token âœ“   â”‚
â”‚  Adds:  x-user-roles:  USER              â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      Order Service                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  @DeleteMapping("/{id}")         â”‚  â”‚
â”‚  â”‚  @PreAuthorize("hasRole('ADMIN')")â”‚ â”‚
â”‚  â”‚                                  â”‚  â”‚
â”‚  â”‚  Spring Security Check:           â”‚  â”‚
â”‚  â”‚  User roles: [USER]              â”‚  â”‚
â”‚  â”‚  Required:  ADMIN                 â”‚  â”‚
â”‚  â”‚  Result: âœ— DENIED                â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 2. 403 Forbidden
       â”‚    {
       â”‚      "error":  "Access Denied",
       â”‚      "message": "Insufficient permissions"
       â”‚    }
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Client    â”‚
â”‚  (Shows     â”‚
â”‚   Error)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 6. Complete Multi-Service Flow

```
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   Client    â”‚
        â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â”‚ Request with JWT
               â”‚
               â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   AWS API Gateway        â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
    â”‚  â”‚ Lambda Authorizer  â”‚  â”‚
    â”‚  â”‚ (Validates JWT)    â”‚  â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€ï¿½ï¿½ï¿½â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â”‚ Adds user context headers
               â”‚
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚        â”‚        â”‚          â”‚         â”‚
      â–¼        â–¼        â–¼          â–¼         â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  Auth  â”‚ â”‚Orderâ”‚ â”‚ Payment â”‚ â”‚Userâ”‚ â”‚Inventoryâ”‚
  â”‚Service â”‚ â”‚Svc  â”‚ â”‚   Svc   â”‚ â”‚Svc â”‚ â”‚   Svc   â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”¬â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚         â”‚
               â”‚         â”‚ Inter-service call
               â”‚         â”‚ (uses service token)
               â”‚         â”‚
               â”‚         â–¼
               â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
               â”‚    â”‚ Payment â”‚
               â””â”€â”€â”€â–ºâ”‚ Gateway â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Each service: 
1. Receives x-user-* headers from API Gateway
2. Builds SecurityContext
3. Applies @PreAuthorize checks
4. Performs business logic authorization
5. Returns response
```

## 7. Security Layers Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     CLIENT                             â”‚
â”‚  Layer 0: Client-side validation (UI restrictions)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              AWS API GATEWAY                           â”‚
â”‚  Layer 1: Network Security                             â”‚
â”‚    â€¢ HTTPS/TLS encryption                              â”‚
â”‚    â€¢ AWS WAF (SQL injection, XSS)                      â”‚
â”‚    â€¢ Rate limiting / Throttling                        â”‚
â”‚    â€¢ CORS policies                                     â”‚
â”‚                                                        â”‚
â”‚  Layer 2: Authentication                               â”‚
â”‚    â€¢ Lambda Authorizer validates JWT                   â”‚
â”‚    â€¢ Checks token signature & expiration               â”‚
â”‚    â€¢ Verifies token not blacklisted                    â”‚
â”‚    â€¢ Returns 401 if invalid                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              MICROSERVICES                             â”‚
â”‚  Layer 3: Authorization (Method Level)                 â”‚
â”‚    â€¢ @PreAuthorize("hasRole('ADMIN')")                 â”‚
â”‚    â€¢ Spring Security checks roles                      â”‚
â”‚    â€¢ Returns 403 if insufficient permissions           â”‚
â”‚                                                        â”‚
â”‚  Layer 4: Business Logic Authorization                 â”‚
â”‚    â€¢ Resource ownership checks                         â”‚
â”‚    â€¢ Custom permission logic                           â”‚
â”‚    â€¢ Data-level security                               â”‚
â”‚    â€¢ Returns 403 if business rules violated            â”‚
â”‚                                                        â”‚
â”‚  Layer 5: Data Access Control                          â”‚
â”‚    â€¢ Database row-level security                       â”‚
â”‚    â€¢ Query filters based on user context               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Key Points:

### **Authentication (Who are you?)**
- Happens at **API Gateway** via Lambda Authorizer
- Validates JWT token signature, expiration, blacklist
- Result: User identity confirmed or rejected (401)

### **Authorization (What can you do?)**
- Happens at **Microservice** level
- **Role-based**:  @PreAuthorize checks roles/permissions (403 if denied)
- **Resource-based**:  Business logic checks ownership (403 if denied)

### **Token Flow:**
1. Client gets token from Auth Service
2. Client includes token in every request
3. API Gateway validates token once
4. API Gateway passes user context to microservices
5. Microservices trust the gateway and perform authorization

This architecture provides **defense in depth** with multiple security layers!  ğŸ”’
